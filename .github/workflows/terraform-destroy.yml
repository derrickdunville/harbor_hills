name: Terraform Destroy

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: "Type DESTROY to confirm."
        required: true
        default: "NO"

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  TF_LOCK_TABLE: ${{ vars.TF_LOCK_TABLE }}
  REPO_NAME: ${{ github.event.repository.name }}

jobs:
  destroy:
    runs-on: ubuntu-latest

    steps:
      - name: Enforce repo owner only
        run: |
          if [ "${GITHUB_ACTOR}" != "${GITHUB_REPOSITORY_OWNER}" ]; then
            echo "Only the repo owner can run this workflow."
            exit 1
          fi

      - name: Confirm destroy
        run: |
          if [ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]; then
            echo "Set confirm_destroy to DESTROY to proceed."
            exit 1
          fi

      - name: Validate required vars
        run: |
          echo "Using AWS_REGION=${AWS_REGION}"

      - name: Validate AWS role secret
        env:
          AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
        run: |
          if [ -z "${AWS_ROLE_ARN}" ]; then
            echo "The AWS_ROLE_ARN is not configured as a secret. You must add the AWS_ROLE_ARN to the repo's secrets. You can provision a new AWS_ROLE_ARN using the aws_account repo."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Resolve state bucket name
        id: resolve_bucket
        run: |
          repo_slug=$(echo "${REPO_NAME}" | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9-' '-')
          repo_slug=$(echo "${repo_slug}" | sed -E 's/^-+//; s/-+$//')
          bucket_prefix="${repo_slug}-tfstate-"
          existing=$(aws s3api list-buckets --query "Buckets[].Name" --output text | tr '\t' '\n' | grep "^${bucket_prefix}[0-9a-f]\\{4\\}$" | head -n1)
          if [ -z "${existing}" ]; then
            echo "No state bucket found for prefix ${bucket_prefix}."
            exit 1
          fi
          echo "TF_STATE_BUCKET=${existing}" >> "$GITHUB_ENV"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform init (infra)
        run: |
          backend_args=(
            "-backend-config=bucket=${TF_STATE_BUCKET}"
            "-backend-config=key=infra/terraform.tfstate"
            "-backend-config=region=${AWS_REGION}"
          )
          if [ -n "${TF_LOCK_TABLE}" ]; then
            backend_args+=("-backend-config=dynamodb_table=${TF_LOCK_TABLE}")
          fi
          terraform -chdir=terraform/infra init "${backend_args[@]}"

      - name: Terraform destroy (infra)
        run: terraform -chdir=terraform/infra destroy -auto-approve -var="aws_region=${AWS_REGION}"
