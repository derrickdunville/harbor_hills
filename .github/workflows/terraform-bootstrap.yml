name: Terraform State Bootstrap

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  TF_LOCK_TABLE: ${{ vars.TF_LOCK_TABLE }}
  REPO_NAME: ${{ github.event.repository.name }}

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Validate required vars
        run: |
          echo "Using AWS_REGION=${AWS_REGION}"

      - name: Validate AWS role secret
        env:
          AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
        run: |
          if [ -z "${AWS_ROLE_ARN}" ]; then
            echo "The AWS_ROLE_ARN is not configured as a secret. You must add the AWS_ROLE_ARN to the repo's secrets. You can provision a new AWS_ROLE_ARN using the aws_account repo."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Resolve state bucket name
        id: resolve_bucket
        run: |
          repo_slug=$(echo "${REPO_NAME}" | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9-' '-')
          repo_slug=$(echo "${repo_slug}" | sed -E 's/^-+//; s/-+$//')
          bucket_prefix="${repo_slug}-tfstate-"
          existing=$(aws s3api list-buckets --query "Buckets[].Name" --output text | tr '\t' '\n' | grep "^${bucket_prefix}[0-9a-f]\\{4\\}$" | head -n1)
          if [ -n "${existing}" ]; then
            echo "TF_STATE_BUCKET=${existing}" >> "$GITHUB_ENV"
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            rand_hex=$(openssl rand -hex 2)
            echo "TF_STATE_BUCKET=${bucket_prefix}${rand_hex}" >> "$GITHUB_ENV"
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Terraform
        if: steps.resolve_bucket.outputs.exists == 'false'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform init
        if: steps.resolve_bucket.outputs.exists == 'false'
        run: terraform -chdir=terraform/bootstrap init

      - name: Terraform apply
        if: steps.resolve_bucket.outputs.exists == 'false'
        run: |
          terraform -chdir=terraform/bootstrap apply -auto-approve \
            -var="aws_region=${AWS_REGION}" \
            -var="state_bucket_name=${TF_STATE_BUCKET}" \
            -var="lock_table_name=${TF_LOCK_TABLE}"
